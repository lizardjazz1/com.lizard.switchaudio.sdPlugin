<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Audio Switch Pro</title>
    <style>
        /* --- RESET & BASE --- */
        * {
            box-sizing: border-box;
            user-select: none;
            outline: none;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-size: 10px;
            background-color: #2d2d2d;
            color: #f0f0f0;
            margin: 0;
            padding: 6px;
            width: 438px;
            height: 195px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Контейнер на всю высоту */
        .container {
            display: none; /* Скрыт пока грузится */
            flex-direction: column;
            height: 100%;
            gap: 5px; /* Отступ между элементами */
        }

        /* --- КАРТОЧКИ УСТРОЙСТВ (Серые плашки) --- */
        .device-group {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            padding: 5px 6px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            flex: 1;
            min-height: 0;
        }

        /* Скрытие элемента */
        .device-group.hidden {
            display: none;
        }

        /* Цветные акценты слева */
        .device-group.primary {
            border-left: 3px solid #4fc3f7;
        }
        .device-group.secondary {
            border-left: 3px solid #ba68c8;
        }

        /* Заголовок внутри карточки */
        .device-label {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            font-weight: 500;
            font-size: 10px;
            color: #ddd;
        }

        /* Иконки с цифрами 1 и 2 */
        .device-label .icon {
            width: 14px;
            height: 14px;
            margin-right: 5px;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: bold;
            color: #fff;
        }
        .device-label .icon.primary { background: #4fc3f7; }
        .device-label .icon.secondary { background: #ba68c8; }

        /* --- SELECT (ВЫПАДАЮЩИЙ СПИСОК) --- */
        select {
            width: 100%;
            height: 20px;
            padding: 0 5px;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 3px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 10px;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        select:hover {
            border-color: rgba(255,255,255,0.3);
        }
        select:focus {
            border-color: #4fc3f7;
        }
        select option {
            background: #2d2d2d;
            color: #fff;
        }

        /* --- КНОПКА ОБНОВИТЬ --- */
        .btn-refresh {
            height: 22px;
            flex-shrink: 0;
            background: linear-gradient(135deg, #3a3a3a 0%, #323232 100%);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 3px;
            color: #ccc;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .btn-refresh:hover {
            background: linear-gradient(135deg, #444 0%, #3a3a3a 100%);
            color: #fff;
            border-color: rgba(255,255,255,0.2);
        }
        
        .btn-refresh:active {
            transform: translateY(1px);
        }

        /* --- ЗАГРУЗКА --- */
        .loading {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
        }

        /* --- RADIO BUTTONS --- */
        .radio-group {
            margin-bottom: 5px;
        }
        .radio-label {
            font-size: 10px;
            color: #ccc;
            margin-bottom: 3px;
            display: block;
        }
        .radio-options {
            display: flex;
            gap: 8px;
        }
        .radio-option {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }
        .radio-option input[type="radio"] {
            margin: 0;
            cursor: pointer;
            width: 12px;
            height: 12px;
        }
        .radio-option label {
            font-size: 10px;
            color: #ddd;
            cursor: pointer;
            margin: 0;
        }

        /* --- СКРЫТИЕ ВТОРОГО УСТРОЙСТВА --- */
        .device-group.secondary.hidden {
            display: none;
        }
    </style>
</head>
<body>

    <div class="container" id="main">
        <!-- Тип устройства (Input/Output) -->
        <div class="radio-group">
            <label class="radio-label" id="deviceTypeLabel">Устройство:</label>
            <div class="radio-options">
                <div class="radio-option">
                    <input type="radio" id="deviceTypeInput" name="deviceType" value="input">
                    <label for="deviceTypeInput" id="deviceTypeInputLabel">Вход</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="deviceTypeOutput" name="deviceType" value="output" checked>
                    <label for="deviceTypeOutput" id="deviceTypeOutputLabel">Выход</label>
                </div>
            </div>
        </div>

        <!-- Режим переключения -->
        <div class="radio-group">
            <label class="radio-label" id="modeLabel">Режим:</label>
            <div class="radio-options">
                <div class="radio-option">
                    <input type="radio" id="modeSelected" name="mode" value="selected">
                    <label for="modeSelected" id="modeSelectedLabel">Переключить на выбранное</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="modeToggle" name="mode" value="toggle" checked>
                    <label for="modeToggle" id="modeToggleLabel">Переключать между двумя</label>
                </div>
            </div>
        </div>

        <!-- Блок 1 -->
        <div class="device-group primary" id="deviceGroup1">
            <div class="device-label">
                <span class="icon primary">1</span>
                <span id="label1">Primary Device</span>
            </div>
            <select id="device1"></select>
        </div>

        <!-- Блок 2 -->
        <div class="device-group secondary" id="deviceGroup2">
            <div class="device-label">
                <span class="icon secondary">2</span>
                <span id="label2">Secondary Device</span>
            </div>
            <select id="device2"></select>
        </div>

        <!-- Кнопка -->
        <button class="btn-refresh" id="refresh">
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 4v6h-6M1 20v-6h6"/>
                <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
            </svg>
            <span id="refreshText">Refresh Devices</span>
        </button>
    </div>

    <div class="loading" id="loading">Loading...</div>

    <script>
        let websocket = null;
        let uuid = null;
        let actionInfo = null;
        let settings = {};
        let devices = [];
        let language = 'en';

        const localization = {
            en: {
                device: 'Device:',
                input: 'Input',
                output: 'Output',
                mode: 'Mode:',
                modeSelected: 'Switch to selected',
                modeToggle: 'Switch between two',
                selectDevice: 'Select device:',
                primary: 'Primary Device',
                secondary: 'Secondary Device',
                refresh: 'Refresh Devices',
                noDevices: 'No devices found',
                loading: 'Loading...'
            },
            ru: {
                device: 'Устройство:',
                input: 'Вход',
                output: 'Выход',
                mode: 'Режим:',
                modeSelected: 'Переключить на выбранное',
                modeToggle: 'Переключать между двумя',
                selectDevice: 'Выбрать устройство:',
                primary: 'Первое устройство',
                secondary: 'Второе устройство',
                refresh: 'Обновить',
                noDevices: 'Нет устройств',
                loading: 'Загрузка...'
            },
            zh: {
                device: '设备:',
                input: '输入',
                output: '输出',
                mode: '模式:',
                modeSelected: '切换到选定',
                modeToggle: '在两个之间切换',
                selectDevice: '选择设备:',
                primary: '主要设备',
                secondary: '次要设备',
                refresh: '刷新列表',
                noDevices: '未找到设备',
                loading: '加载中...'
            }
        };

        const els = {
            main: document.getElementById('main'),
            loading: document.getElementById('loading'),
            deviceTypeLabel: document.getElementById('deviceTypeLabel'),
            deviceTypeInput: document.getElementById('deviceTypeInput'),
            deviceTypeOutput: document.getElementById('deviceTypeOutput'),
            deviceTypeInputLabel: document.getElementById('deviceTypeInputLabel'),
            deviceTypeOutputLabel: document.getElementById('deviceTypeOutputLabel'),
            modeLabel: document.getElementById('modeLabel'),
            modeSelected: document.getElementById('modeSelected'),
            modeToggle: document.getElementById('modeToggle'),
            modeSelectedLabel: document.getElementById('modeSelectedLabel'),
            modeToggleLabel: document.getElementById('modeToggleLabel'),
            deviceGroup1: document.getElementById('deviceGroup1'),
            deviceGroup2: document.getElementById('deviceGroup2'),
            device1: document.getElementById('device1'),
            device2: document.getElementById('device2'),
            label1: document.getElementById('label1'),
            label2: document.getElementById('label2'),
            refreshBtn: document.getElementById('refresh'),
            refreshText: document.getElementById('refreshText')
        };

        function setLanguage(langCode) {
            if (!langCode) langCode = 'en';
            langCode = langCode.toLowerCase();
            if (langCode.startsWith('ru')) language = 'ru';
            else if (langCode.startsWith('zh')) language = 'zh';
            else language = 'en';
            
            const loc = localization[language];
            els.deviceTypeLabel.textContent = loc.device;
            els.deviceTypeInputLabel.textContent = loc.input;
            els.deviceTypeOutputLabel.textContent = loc.output;
            els.modeLabel.textContent = loc.mode;
            els.modeSelectedLabel.textContent = loc.modeSelected;
            els.modeToggleLabel.textContent = loc.modeToggle;
            els.label1.textContent = loc.selectDevice;
            els.label2.textContent = loc.selectDevice;
            els.refreshText.textContent = loc.refresh;
            els.loading.textContent = loc.loading;
        }

        function updateModeVisibility() {
            // Read mode from radio buttons directly (they update before settings)
            const mode = els.modeSelected.checked ? 'selected' : 'toggle';
            if (mode === 'selected') {
                els.deviceGroup2.classList.add('hidden');
            } else {
                els.deviceGroup2.classList.remove('hidden');
            }
        }

        function connectElgatoStreamDeckSocket(port, propertyInspectorUUID, registerEvent, info, actionInfoStr) {
            uuid = propertyInspectorUUID;
            actionInfo = JSON.parse(actionInfoStr);
            settings = actionInfo.payload.settings || {};

            try {
                const infoObj = JSON.parse(info);
                const appLang = infoObj.application && infoObj.application.language;
                setLanguage(appLang || navigator.language);
            } catch (e) {
                setLanguage(navigator.language);
            }

            // Initialize UI with current settings
            updateUIFromSettings();

            websocket = new WebSocket('ws://127.0.0.1:' + port);

            websocket.onopen = function() {
                websocket.send(JSON.stringify({
                    event: registerEvent,
                    uuid: uuid
                }));
                requestDevices();
            };

            websocket.onmessage = function(evt) {
                try {
                    const data = JSON.parse(evt.data);

                    if (data.event === 'sendToPropertyInspector') {
                        if (data.payload && data.payload.devices) {
                            devices = data.payload.devices;
                            renderDevices();
                            els.loading.style.display = 'none';
                            els.main.style.display = 'flex';
                        }
                    }

                    if (data.event === 'didReceiveSettings') {
                        settings = data.payload.settings || {};
                        updateSelection();
                        updateUIFromSettings();
                    }
                } catch (e) {
                    console.error('Error parsing message:', e);
                }
            };
        }

        function requestDevices() {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                els.main.style.display = 'none';
                els.loading.style.display = 'flex';
                
                const deviceType = settings.deviceType || 'output';
                websocket.send(JSON.stringify({
                    event: 'sendToPlugin',
                    action: actionInfo.action,
                    context: uuid,
                    payload: { requestDevices: true, deviceType: deviceType }
                }));
            }
        }

        function renderDevices() {
            const loc = localization[language];
            els.device1.innerHTML = '';
            els.device2.innerHTML = '';

            if (!devices || devices.length === 0) {
                const opt = new Option(loc.noDevices, "", true, true);
                opt.disabled = true;
                els.device1.add(opt.cloneNode(true));
                els.device2.add(opt);
                return;
            }

            devices.forEach(device => {
                const name = device.name || device.Name || 'Unknown';
                const id = device.id || device.ID || name;
                
                const opt1 = document.createElement('option');
                opt1.value = id;
                opt1.textContent = name;
                opt1.dataset.name = name;
                els.device1.appendChild(opt1);

                const opt2 = document.createElement('option');
                opt2.value = id;
                opt2.textContent = name;
                opt2.dataset.name = name;
                els.device2.appendChild(opt2);
            });

            if (devices.length > 1 && !settings.device2) {
                els.device2.selectedIndex = 1;
            }
            updateSelection();
        }

        function updateSelection() {
            if (settings.device1) els.device1.value = settings.device1;
            if (settings.device2) els.device2.value = settings.device2;
        }

        function updateUIFromSettings() {
            // Device type
            const deviceType = settings.deviceType || 'output';
            if (deviceType === 'input') {
                els.deviceTypeInput.checked = true;
            } else {
                els.deviceTypeOutput.checked = true;
            }
            
            // Mode
            const mode = settings.mode || 'toggle';
            if (mode === 'selected') {
                els.modeSelected.checked = true;
            } else {
                els.modeToggle.checked = true;
            }
            
            updateModeVisibility();
        }

        function saveSettings() {
            const sel1 = els.device1.options[els.device1.selectedIndex];
            const sel2 = els.device2.options[els.device2.selectedIndex];

            // Save device type
            settings.deviceType = els.deviceTypeInput.checked ? 'input' : 'output';
            
            // Save mode
            settings.mode = els.modeSelected.checked ? 'selected' : 'toggle';
            
            // Save devices
            settings.device1 = els.device1.value;
            settings.device1Name = sel1 ? sel1.dataset.name : '';
            
            if (settings.mode === 'toggle') {
                // In "toggle" mode: save both devices for switching between them
                settings.device2 = els.device2.value;
                settings.device2Name = sel2 ? sel2.dataset.name : '';
            } else {
                // In "selected" mode: only device1 is used (selected device)
                // device2 is not used in this mode
                delete settings.device2;
                delete settings.device2Name;
            }

            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({
                    event: 'setSettings',
                    context: uuid,
                    payload: settings
                }));
            }
        }

        // Event listeners
        els.deviceTypeInput.addEventListener('change', () => {
            saveSettings();
            requestDevices(); // Reload devices when type changes
        });
        els.deviceTypeOutput.addEventListener('change', () => {
            saveSettings();
            requestDevices(); // Reload devices when type changes
        });
        
        els.modeSelected.addEventListener('change', () => {
            updateModeVisibility();
            saveSettings();
        });
        els.modeToggle.addEventListener('change', () => {
            updateModeVisibility();
            saveSettings();
        });
        
        els.device1.addEventListener('change', saveSettings);
        els.device2.addEventListener('change', saveSettings);
        els.refreshBtn.addEventListener('click', requestDevices);
    </script>
</body>
</html>
